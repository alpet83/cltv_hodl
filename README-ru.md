content-encoding: utf-8
# CLTV HODL scripts pack

Возможно вы задумывались иногда как сохранить ваши биткойны надолго? На недели, месяцы, годы, до следующего халвинга или наступления старости? Это не так просто, когда цена растет и столько искушений потратить монеты. Однако есть решение, заблокировать трату биткойнов до четко установленной даты.

Для надежной заморозки монет, их требуется отправить на адрес сценария использующего операцию OP_CHECKLOCKTIMEVERIFY, которая не позволит трату до заданного срока. Существует несколько вариантов реализации, я выбрал Pay-To-Witness-Script-Hash использовав для адаптации скрипт отсюда: https://github.com/bitcoin-studio/Bitcoin-Programming-with-BitcoinJS/ Потребовалось разбить скрипт на несколько, добавить проверочный код и работу с файлами конфигурации.
Тем не менее, работать с решением попрежнему можно в терминалах bash/sh, в системе Linux.

### Что потребуется установить и настроить:
  1. Клиент Bitcoin, как минимум bitcoind и bitcoin-cli версии >= 0.16, необходимо включить локальный доступ RPC, опцию **txindex=1** в *~/.bitcoin/bitcoin.conf*, дождаться синхронизации данных блокчейн.
  2. nodejs LTS версии >= 8.0, npm
  3. Библиотеки и модули: `npm install bitcoinjs-lib colors ecpair bip32 bip56 jsonfile`

Все операции желательно проводить в надежных условиях, где исключены разные сбои вроде потери питания. Требуется максимум внимательности и осторожности, чтобы не потерять доступ к своим средствам! Чтобы получить так называемый hodl-aдрес, на котором будут заморожены монеты, потребуется сохранить приватный ключ, которым в дальнейшем будут подписываться транзакции возвращения монет (см. шаг 1). Перед началом работы, уже должен быть готов кошелек с адресами, на которые монеты будут возвращаться - резервные копии также стоит сделать. Ради удобства и скорости работы, пришлось отчасти пожертвовать безопасностью: отправлять биткойны потребуется с той-же самой системы, где будут запускаться сценарии. Соответственно, кошелек должен быть зашифрован, и разблокировать его нужно лишь на 1 и 5 шаге работы.     

Безусловно, начинать экспериментировать стоит с минимальными транзакциями до 100000 сатоши, с временем блокировки 1-2 часа. Не рекомендую блокировать значительные средства, без очень веских на то оснований. В любой момент может произойти очередной эйрдроп-форк, вроде Bitcoin Gold, с недолгосрочной возможностью продать по хорошей цене. Блокировка на годы, с большой вероятностью не позволит вам тратить монеты эйрдропа, даже в будущем (совместимость транзакций не гарантируется!).  

### Руководство к действию:
 1. Генерация приватного ключа hodlmaster_key.json через запуск `getprivkey.sh <wallet-name> <bitcoin_addres>` или `node make_privkey.js <wallet-name> <hdseedpath>`    (кошелек потребуется разблокировать). 
 2. Отредактировать hodl_ts с указанием желаемой даты-времени разблокировки.
 3. Инициализировать конфигурацию: `./init.sh` 
 4. Создать hodl-адрес выполнив: `node cltv_hodl.js` 
 5. Пополнить hodl-адрес выполнив, после очередной разблокировки: `bitcoin-cli sendtoaddress <address> <amount>` (альтернативно можно использовать sh hodlbtc.sh <amount>, после задания пароля кошелька в unlock.js)  
 6. Сохранить ID транзакции в конфигурацию, выполнив: `node sethodltx.js <TXID>` в случае ручной отправки транзакции
 7. Создать "сырую" транзакцию разблокировки и вывода средств: `node cltv_unhodl.js <payee_address>`
 8. Сохранить код сырой транзакции, в виде HEX строки `TXRAW="020000000001018d01...."`, сделав также и резервную копию
 9. Попробовать разослать транзакцию командой: `bitcoin-cli sendrawtransaction 020000000001018d01....` - должен быть выдан код ошибки non-final (code 64)
10. Примерно через 1-2 часа, после истечения срока блокировки, попробовать повторно разослать транзакцию. Задержка требуется потому, что с временем блокировки сеть сравнивает среднее время за 11 последних блоков.
 
Таким образом можно получать персональный банк, с срочным вкладом, и инструмент изьятия этого вклада на жестко определенный адрес. Получается, что хранить сырые транзакции можно и без шифрования, т.к. максимум что может сделать получивший к ней доступ, это отправить в сеть раньше чем вы. С другой стороны, нежелательно давать любую информацию злоумышленникам, а в коде транзакции скрывается адрес назначения.  

Шаги с 7 по 10 можно сделать для разных адресов получателей, получив отличающиеся транзакции. Это скажем позволяет завещать монеты на случай недожития: транзакцию с выводом монет на адрес родственника можно распечатать и приложить к завещанию. При готовности альтернативных транзакций, в теории можно даже избавиться от приватного ключа, использованного для их создания (hodlmaster_key.json). Впрочем, при этом увеличивается риск невозможности использовать монеты эйрдропов, поскольку сырые транзакции могут оказаться несовместимыми по формату с новым форком. Хранить кошелек с этим приватным ключем надлежит в зашифрованном виде, с несколькими резервными копиями желательно.         

P.S.:
Исходя из опыта использования: обновляются клиент bitcoin и библиотека bitcoinlib-js, что может сделать представленные скрипты неработоспособными. Поэтому на случай необходимости изменения целевых кошельков, рекомендуется сделать полный двоичный бэкап системы, на которой производилась генерация консервирующих адресов. Это особенно легко, если использовался одноплатный компьютер вроде Raspberry Pi - просто клонировать MicroSD карту. 
         
                                